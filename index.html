<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–¢–µ—Ä–∞–ø—ñ—è –î—ñ—ó</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #efeff4);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --header-height: 155px; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Roboto', Helvetica, sans-serif;
            background-color: var(--secondary-bg-color); 
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-top: calc(var(--header-height) + env(safe-area-inset-top)); 
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER --- */
        .fixed-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            background-color: var(--secondary-bg-color);
            z-index: 1000;
            padding-top: env(safe-area-inset-top); 
            padding-bottom: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); 
        }

        .category-header { padding: 10px 16px 0 16px; }
        .category-title { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        .category-subtitle { font-size: 14px; color: var(--hint-color); margin-top: 2px; text-transform: uppercase; font-weight: 600; }

        .balance-badge {
            display: inline-flex; align-items: center;
            background: var(--bg-color); padding: 4px 10px;
            border-radius: 12px; font-size: 13px; font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-top: 8px;
        }

        /* --- TABS --- */
        .tabs-container { padding: 15px 16px 10px 16px; display: flex; gap: 8px; }
        .tab {
            flex: 1; text-align: center; padding: 8px 0;
            border-radius: 8px; font-size: 13px; font-weight: 600;
            background-color: var(--bg-color); color: var(--text-color);
            transition: all 0.2s ease; cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid transparent;
        }
        .tab.active {
            background-color: var(--button-color); color: var(--button-text-color);
            box-shadow: 0 2px 8px rgba(51, 144, 236, 0.4);
        }

        /* --- LIST --- */
        .list-group { margin: 10px 16px 40px 16px; background-color: var(--bg-color); border-radius: 14px; overflow: hidden; }
        
        .task-row { 
            display: flex; 
            align-items: flex-start; 
            padding: 16px; 
            position: relative; 
            transition: opacity 0.3s ease;
        }
        
        .task-row:active { background-color: var(--secondary-bg-color); }
        .task-row:not(:last-child)::after {
            content: ""; position: absolute; bottom: 0; left: 60px; right: 0; height: 1px; background-color: var(--secondary-bg-color);
        }

        .task-icon {
            width: 40px; height: 40px; border-radius: 10px;
            background-color: rgba(142, 142, 147, 0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-right: 12px; flex-shrink: 0;
            margin-top: 2px;
        }

        .task-content { flex-grow: 1; min-width: 0; margin-right: 10px; }
        
        .task-header-line {
            display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 4px;
        }

        .task-title { font-size: 16px; font-weight: 700; line-height: 1.2; }
        
        /* Reward Badge */
        .reward-tag {
            background-color: #ff9f0a; 
            color: white;
            font-size: 11px; font-weight: 700;
            padding: 2px 6px; border-radius: 6px;
            white-space: nowrap;
        }

        .task-desc { 
            font-size: 13px; 
            color: var(--hint-color); 
            line-height: 1.4;
            white-space: normal; 
        }

        /* –ö–Ω–æ–ø–∫–∞ –í–ò–ö–û–ù–ê–¢–ò */
        .btn-get {
            background-color: var(--secondary-bg-color); 
            color: var(--button-color);
            font-weight: 800; font-size: 11px; 
            padding: 8px 12px; border-radius: 18px;
            border: none; text-transform: uppercase;
            cursor: pointer; flex-shrink: 0;
            margin-top: 2px;
        }
        
        /* –°–¢–ò–õ–Ü –î–õ–Ø –í–ò–ö–û–ù–ê–ù–û–ì–û –ó–ê–í–î–ê–ù–ù–Ø (–°—ñ—Ä–∏–π –∫–æ–ª—ñ—Ä) */
        .task-row.completed { 
            opacity: 0.6; /* –†–æ–±–∏–º–æ –≤—Å–µ –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–º */
            pointer-events: none; /* –ë–ª–æ–∫—É—î–º–æ –∫–ª—ñ–∫–∏ */
        }
        .task-row.completed .task-title { 
            text-decoration: line-through; 
            color: var(--hint-color); 
        }
        .task-row.completed .reward-tag { display: none; } /* –•–æ–≤–∞—î–º–æ —Ü—ñ–Ω—É */
        .task-row.completed .task-icon { filter: grayscale(100%); opacity: 0.5; }
        
        /* –ó–º—ñ–Ω—é—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞ –≥–∞–ª–æ—á–∫—É */
        .task-row.completed .btn-get { 
            background: transparent; 
            color: #28a745; /* –ó–µ–ª–µ–Ω–∞ –≥–∞–ª–æ—á–∫–∞ */
            font-size: 16px;
            cursor: default; 
            border: 1px solid #28a745;
        }

        .loader { text-align: center; padding: 40px; color: var(--hint-color); font-size: 14px; }
    </style>
</head>
<body>

    <div class="fixed-header">
        <div class="category-header">
            <div class="category-subtitle">–ú–æ–¥—É–ª—å —Ç–µ—Ä–∞–ø—ñ—ó</div>
            <h1 class="category-title" id="categoryTitle">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
            <div class="balance-badge">üíé –ë–∞–ª–∞–Ω—Å: <span id="userCoins">0</span></div>
        </div>
        <div class="tabs-container" id="levelTabs"></div>
    </div>

    <div id="taskListContainer">
        <div class="loader">–ó'—î–¥–Ω–∞–Ω–Ω—è –∑ –±–∞–∑–æ—é...</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://vhokdelmvcrpvxyimhyu.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_yNX1v2TvnxrQr3qNwYFq6A_4ceXaXlY'; 

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor(getComputedStyle(document.body).getPropertyValue('--secondary-bg-color').trim());

        // 1. –û–¢–†–ò–ú–£–Ñ–ú–û ID –Æ–ó–ï–†–ê
        // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ –≤ Telegram - –±–µ—Ä–µ–º–æ —Ä–µ–∞–ª—å–Ω–∏–π ID. –Ø–∫—â–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ - —Ç–µ—Å—Ç–æ–≤–∏–π ID.
        const userId = tg.initDataUnsafe?.user?.id || 12345;
        console.log("Current User ID:", userId);

        const urlParams = new URLSearchParams(window.location.search);
        const activeCategory = urlParams.get('category') || "–Ü–ø–æ—Ö–æ–Ω–¥—Ä—ñ—è"; 
        
        let currentLevel = 1;
        let tasksDB = []; 
        let completedTaskIds = []; // –¢—É—Ç –±—É–¥—É—Ç—å —Ä–µ–∞–ª—å–Ω—ñ –≤–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

        // –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø (–ü–∞—Ä–∞–ª–µ–ª—å–Ω–æ 2 –∑–∞–ø–∏—Ç–∏)
        async function initApp() {
            document.getElementById('categoryTitle').innerText = activeCategory;
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ–±–∏–¥–≤–∞ –∑–∞–ø–∏—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
            await Promise.all([fetchTasks(), fetchUserProgress()]);
            
            renderLevelTabs();
            renderTasks();
        }

        // 2. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ó–ê–í–î–ê–ù–¨ (–ö–∞—Ç–∞–ª–æ–≥)
        async function fetchTasks() {
            try {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .eq('category', activeCategory)
                    .order('id', { ascending: true });

                if (error) throw error;
                tasksDB = data; 
            } catch (err) {
                console.error("Error fetching tasks:", err);
            }
        }

        // 3. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ü–†–û–ì–†–ï–°–£ –Æ–ó–ï–†–ê (–©–æ –≤–∏–∫–æ–Ω–∞–Ω–æ)
        async function fetchUserProgress() {
            try {
                // –ü–∏—Ç–∞—î–º–æ –±–∞–∑—É: "–Ø–∫—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —î –≤ user_tasks –¥–ª—è —Ü—å–æ–≥–æ userId?"
                const { data, error } = await supabaseClient
                    .from('user_tasks')
                    .select('task_id')
                    .eq('user_id', userId); // –§—ñ–ª—å—Ç—Ä –ø–æ ID —é–∑–µ—Ä–∞

                if (error) throw error;

                // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –º–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤ [{task_id: 1}, {task_id: 5}] –≤ –ø—Ä–æ—Å—Ç–∏–π –º–∞—Å–∏–≤ [1, 5]
                completedTaskIds = data.map(record => record.task_id);
                console.log("Completed Tasks:", completedTaskIds);

            } catch (err) {
                console.error("Error fetching user progress:", err);
            }
        }

        function renderLevelTabs() {
            const container = document.getElementById('levelTabs');
            container.innerHTML = '';
            
            [1, 2, 3].forEach(lvl => {
                const el = document.createElement('div');
                el.className = `tab ${lvl === currentLevel ? 'active' : ''}`;
                el.innerText = `–†—ñ–≤–µ–Ω—å ${lvl}`;
                el.onclick = () => {
                    if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                    currentLevel = lvl;
                    renderLevelTabs();
                    renderTasks();
                };
                container.appendChild(el);
            });
        }

        function renderTasks() {
            const container = document.getElementById('taskListContainer');
            container.innerHTML = '';

            const filtered = tasksDB.filter(t => t.level === currentLevel);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="loader">–ó–∞–≤–¥–∞–Ω—å –¥–ª—è —Ü—å–æ–≥–æ —Ä—ñ–≤–Ω—è —â–µ –Ω–µ–º–∞—î</div>`;
                return;
            }

            const listGroup = document.createElement('div');
            listGroup.className = 'list-group';

            filtered.forEach((task) => {
                // –ü–ï–†–ï–í–Ü–†–Ø–Ñ–ú–û: –ß–∏ —î ID —Ü—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –≤ —Å–ø–∏—Å–∫—É –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö?
                const isCompleted = completedTaskIds.includes(task.id);
                
                const row = document.createElement('div');
                // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å .completed, —è–∫—â–æ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–µ
                row.className = `task-row ${isCompleted ? 'completed' : ''}`;
                
                row.innerHTML = `
                    <div class="task-icon">${task.icon}</div>
                    
                    <div class="task-content">
                        <div class="task-header-line">
                            <span class="task-title">${task.title}</span>
                            ${!isCompleted ? `<span class="reward-tag">+${task.reward}</span>` : ''}
                        </div>
                        <div class="task-desc">${task.description}</div>
                    </div>

                    <button class="btn-get" onclick="handleTask(${task.id})">
                        ${isCompleted ? '‚úì' : '–í–ò–ö–û–ù–ê–¢–ò'}
                    </button>
                `;
                listGroup.appendChild(row);
            });

            container.appendChild(listGroup);
        }

        function handleTask(taskId) {
            // –ó–∞—Ö–∏—Å—Ç: –Ω–µ –¥–∞—î–º–æ –∫–ª—ñ–∫–∞—Ç–∏, —è–∫—â–æ –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–æ (—Ö–æ—á–∞ CSS —Ç–µ–∂ –±–ª–æ–∫—É—î)
            if (completedTaskIds.includes(taskId)) return;
            
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            const selectedTask = tasksDB.find(t => t.id === taskId);
            
            if (!selectedTask) return;

            const flowId = "696be91e0f12dc4a9001cfc8"; 

            const params = new URLSearchParams({
                start: flowId,
                task_id: selectedTask.id,
                task_category: selectedTask.category,
                task_level: selectedTask.level,
                task_title: selectedTask.title,
                task_description: selectedTask.description,
                task_reward: selectedTask.reward,
                task_type: selectedTask.submission_type || 'text' 
            });

            const url = `https://tg.pulse.is/noo_panic_bot?${params.toString()}`;
            
            tg.openLink(url); 
            tg.close();
        }

        // –ó–ê–ü–£–°–ö
        initApp();
    </script>
</body>
</html>
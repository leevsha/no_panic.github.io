<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–¢–µ—Ä–∞–ø—ñ—è –î—ñ—ó</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #efeff4);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --header-height: 155px; 
            --danger-color: #ff3b30;
            --success-color: #28a745;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Roboto', Helvetica, sans-serif;
            background-color: var(--secondary-bg-color); 
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-top: calc(var(--header-height) + env(safe-area-inset-top)); 
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER --- */
        .fixed-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            background-color: var(--secondary-bg-color);
            z-index: 1000;
            padding-top: env(safe-area-inset-top); 
            padding-bottom: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); 
        }

        .category-header { padding: 10px 16px 0 16px; }
        .category-title { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        .category-subtitle { font-size: 14px; color: var(--hint-color); margin-top: 2px; text-transform: uppercase; font-weight: 600; }

        .balance-badge {
            display: inline-flex; align-items: center;
            background: var(--bg-color); padding: 4px 10px;
            border-radius: 12px; font-size: 13px; font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-top: 8px;
        }

        /* --- TABS --- */
        .tabs-container { padding: 15px 16px 10px 16px; display: flex; gap: 8px; }
        .tab {
            flex: 1; text-align: center; padding: 8px 0;
            border-radius: 8px; font-size: 13px; font-weight: 600;
            background-color: var(--bg-color); color: var(--text-color);
            transition: all 0.2s ease; cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid transparent;
        }
        .tab.active {
            background-color: var(--button-color); color: var(--button-text-color);
            box-shadow: 0 2px 8px rgba(51, 144, 236, 0.4);
        }

        /* --- LISTS --- */
        .list-group { margin: 10px 16px 40px 16px; background-color: var(--bg-color); border-radius: 14px; overflow: hidden; }
        
        .task-row { 
            display: flex; align-items: flex-start; padding: 16px; position: relative; transition: opacity 0.3s ease;
        }
        .task-row:active { background-color: var(--secondary-bg-color); }
        .task-row:not(:last-child)::after {
            content: ""; position: absolute; bottom: 0; left: 60px; right: 0; height: 1px; background-color: var(--secondary-bg-color);
        }

        .task-icon {
            width: 40px; height: 40px; border-radius: 10px;
            background-color: rgba(142, 142, 147, 0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-right: 12px; flex-shrink: 0; margin-top: 2px;
        }

        .task-content { flex-grow: 1; min-width: 0; margin-right: 10px; }
        .task-header-line { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 4px; }
        .task-title { font-size: 16px; font-weight: 700; line-height: 1.2; }
        
        .reward-tag {
            background-color: #ff9f0a; color: white; font-size: 11px; font-weight: 700;
            padding: 2px 6px; border-radius: 6px; white-space: nowrap;
        }
        .price-tag {
            background-color: var(--text-color); color: var(--bg-color); font-size: 11px; font-weight: 700;
            padding: 2px 6px; border-radius: 6px; white-space: nowrap;
        }
        
        .task-desc { font-size: 13px; color: var(--hint-color); line-height: 1.4; white-space: normal; }

        .btn-get, .btn-buy {
            font-weight: 800; font-size: 11px; padding: 8px 12px; border-radius: 18px;
            border: none; text-transform: uppercase; cursor: pointer; flex-shrink: 0; margin-top: 2px;
        }
        .btn-get { background-color: var(--secondary-bg-color); color: var(--button-color); }
        .btn-buy { background-color: var(--button-color); color: #fff; }

        /* Styles for Completed/Purchased */
        .task-row.completed { opacity: 0.6; pointer-events: none; }
        .task-row.completed .task-title { text-decoration: line-through; color: var(--hint-color); }
        .task-row.completed .reward-tag { display: none; } 
        .task-row.completed .task-icon { filter: grayscale(100%); opacity: 0.5; }
        
        .task-row.completed .btn-get, 
        .task-row.completed .btn-buy { 
            background: transparent; 
            color: var(--success-color); 
            font-size: 14px; 
            cursor: default; 
            border: 1px solid var(--success-color);
            padding: 6px 10px;
        }

        .loader { text-align: center; padding: 40px; color: var(--hint-color); font-size: 14px; }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: var(--bg-color);
            border-top: 1px solid var(--secondary-bg-color);
            display: flex; justify-content: space-around;
            padding: 10px 0 20px 0;
            z-index: 1000;
        }
        .nav-item {
            flex: 1; text-align: center; cursor: pointer;
            color: var(--hint-color); transition: 0.2s;
        }
        .nav-item.active { color: var(--button-color); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }
        .nav-label { font-size: 10px; font-weight: 600; text-transform: uppercase; }

        /* --- ACCESS DENIED --- */
        #accessDeniedScreen {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-color); z-index: 2000;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        .lock-icon { font-size: 60px; margin-bottom: 20px; }
        .denied-title { font-size: 22px; font-weight: 800; margin-bottom: 10px; }
        .denied-text { font-size: 15px; color: var(--hint-color); max-width: 300px; margin-bottom: 30px; }
        .btn-subscribe {
            background-color: var(--button-color); color: var(--button-text-color);
            padding: 12px 30px; border-radius: 12px; font-size: 16px; font-weight: 600; border: none; cursor: pointer;
        }

        #shopView { display: none; }

    </style>
</head>
<body>

    <div id="accessDeniedScreen">
        <div class="lock-icon">üîí</div>
        <div class="denied-title">–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä–∏—Ç–∏–π</div>
        <div class="denied-text">–¶–µ–π —Ä–æ–∑–¥—ñ–ª –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –¥–ª—è —É—á–∞—Å–Ω–∏–∫—ñ–≤ –∫–ª—É–±—É –∑ –∞–∫—Ç–∏–≤–Ω–æ—é –ø—ñ–¥–ø–∏—Å–∫–æ—é.</div>
        <button class="btn-subscribe" onclick="tg.close()">–ó—Ä–æ–∑—É–º—ñ–ª–æ</button>
    </div>

    <div id="appContent">
        <div class="fixed-header">
            <div class="category-header">
                <div class="category-subtitle">–ú–æ–¥—É–ª—å —Ç–µ—Ä–∞–ø—ñ—ó</div>
                <h1 class="category-title" id="pageTitle">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
                <div class="balance-badge">üíé –ë–∞–ª–∞–Ω—Å: <span id="userCoins">...</span></div>
            </div>
            <div class="tabs-container" id="levelTabs"></div>
        </div>

        <div id="tasksView">
            <div id="taskListContainer">
                <div class="loader">–ó'—î–¥–Ω–∞–Ω–Ω—è –∑ –±–∞–∑–æ—é...</div>
            </div>
        </div>

        <div id="shopView">
            <div id="shopListContainer">
                <div class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞–≥–∞–∑–∏–Ω—É...</div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('tasks')" id="navTasks">
                <span class="nav-icon">üìù</span>
                <span class="nav-label">–ó–∞–≤–¥–∞–Ω–Ω—è</span>
            </div>
            <div class="nav-item" onclick="switchTab('shop')" id="navShop">
                <span class="nav-icon">üõçÔ∏è</span>
                <span class="nav-label">–ú–∞–≥–∞–∑–∏–Ω</span>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vhokdelmvcrpvxyimhyu.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_yNX1v2TvnxrQr3qNwYFq6A_4ceXaXlY'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor(getComputedStyle(document.body).getPropertyValue('--secondary-bg-color').trim());

        // ID –Æ–ó–ï–†–ê
        const userId = tg.initDataUnsafe?.user?.id || 12345;
        
        const urlParams = new URLSearchParams(window.location.search);
        
        // --- 1. –ü–ï–†–ï–í–Ü–†–Ø–Ñ–ú–û –ü–ê–†–ê–ú–ï–¢–†–ò ---
        const activeCategory = urlParams.get('category') || "–Ü–ø–æ—Ö–æ–Ω–¥—Ä—ñ—è"; 
        const startMode = urlParams.get('mode'); // 'shop' –∞–±–æ null
        
        let currentLevel = 1;
        let tasksDB = []; 
        let productsDB = [];
        let completedTaskIds = [];
        let purchasedProductIds = [];
        let currentBalance = 0;

        async function initApp() {
            const hasAccess = await checkUserAndBalance();
            if (!hasAccess) {
                document.getElementById('appContent').style.display = 'none';
                document.getElementById('accessDeniedScreen').style.display = 'flex';
                return;
            }

            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–æ–∫–∏ —â–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∫–∞—Ç–µ–≥–æ—Ä—ñ—è)
            document.getElementById('pageTitle').innerText = activeCategory;

            // –í–∞–Ω—Ç–∞–∂–∏–º–æ –≤—Å–µ
            await Promise.all([
                fetchTasks(), 
                fetchUserProgress(), 
                fetchProducts(),
                fetchUserPurchases()
            ]);
            
            // –†–µ–Ω–¥–µ—Ä–∏–º–æ
            renderLevelTabs();
            renderTasks();
            renderShop();

            // --- 2. –í–ò–†–Ü–®–£–Ñ–ú–û, –©–û –ü–û–ö–ê–ó–ê–¢–ò –ü–ï–†–®–ò–ú ---
            if (startMode === 'shop') {
                switchTab('shop'); // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–∞–≥–∞–∑–∏–Ω
            } else {
                switchTab('tasks'); // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ)
            }
        }

        // --- NAV ---
        function switchTab(tabName) {
            document.getElementById('navTasks').classList.remove('active');
            document.getElementById('navShop').classList.remove('active');
            
            document.getElementById('tasksView').style.display = 'none';
            document.getElementById('shopView').style.display = 'none';
            document.getElementById('levelTabs').style.display = 'none'; 

            if (tabName === 'tasks') {
                document.getElementById('navTasks').classList.add('active');
                document.getElementById('tasksView').style.display = 'block';
                document.getElementById('levelTabs').style.display = 'flex';
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∑–∞–≤–¥–∞–Ω—å - —Ü–µ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è
                document.getElementById('pageTitle').innerText = activeCategory; 
            } else if (tabName === 'shop') {
                document.getElementById('navShop').classList.add('active');
                document.getElementById('shopView').style.display = 'block';
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω—É
                document.getElementById('pageTitle').innerText = "–ú–∞–≥–∞–∑–∏–Ω";
            }
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        // --- FETCHING ---
        async function checkUserAndBalance() {
            try {
                const { data, error } = await supabaseClient
                    .from('users').select('balance').eq('telegram_id', userId).single();
                if (error || !data) return false;
                
                currentBalance = data.balance;
                document.getElementById('userCoins').innerText = currentBalance;
                return true;
            } catch (err) { return false; }
        }

        async function fetchTasks() {
            const { data } = await supabaseClient
                .from('tasks').select('*').eq('category', activeCategory).order('id', { ascending: true });
            if (data) tasksDB = data;
        }

        async function fetchUserProgress() {
            const { data } = await supabaseClient
                .from('user_tasks').select('task_id').eq('user_id', userId);
            if (data) completedTaskIds = data.map(r => r.task_id);
        }

        async function fetchProducts() {
            const { data } = await supabaseClient
                .from('products').select('*').order('price', { ascending: true });
            if (data) productsDB = data;
        }

        async function fetchUserPurchases() {
            const { data } = await supabaseClient
                .from('user_purchases').select('product_id').eq('user_id', userId);
            if (data) {
                purchasedProductIds = data.map(r => r.product_id);
            }
        }

        // --- RENDER ---
        function renderLevelTabs() {
            const container = document.getElementById('levelTabs');
            container.innerHTML = '';
            [1, 2, 3].forEach(lvl => {
                const el = document.createElement('div');
                el.className = `tab ${lvl === currentLevel ? 'active' : ''}`;
                el.innerText = `–†—ñ–≤–µ–Ω—å ${lvl}`;
                el.onclick = () => {
                    if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                    currentLevel = lvl;
                    renderLevelTabs();
                    renderTasks();
                };
                container.appendChild(el);
            });
        }

        function renderTasks() {
            const container = document.getElementById('taskListContainer');
            container.innerHTML = '';
            const filtered = tasksDB.filter(t => t.level === currentLevel);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="loader">–ó–∞–≤–¥–∞–Ω—å –¥–ª—è —Ü—å–æ–≥–æ —Ä—ñ–≤–Ω—è —â–µ –Ω–µ–º–∞—î</div>`;
                return;
            }

            const listGroup = document.createElement('div');
            listGroup.className = 'list-group';

            filtered.forEach((task) => {
                const isCompleted = completedTaskIds.includes(task.id);
                const row = document.createElement('div');
                row.className = `task-row ${isCompleted ? 'completed' : ''}`;
                row.innerHTML = `
                    <div class="task-icon">${task.icon}</div>
                    <div class="task-content">
                        <div class="task-header-line">
                            <span class="task-title">${task.title}</span>
                            ${!isCompleted ? `<span class="reward-tag">+${task.reward}</span>` : ''}
                        </div>
                        <div class="task-desc">${task.description}</div>
                    </div>
                    <button class="btn-get" onclick="handleTask(${task.id})">
                        ${isCompleted ? '‚úì' : '–í–ò–ö–û–ù–ê–¢–ò'}
                    </button>
                `;
                listGroup.appendChild(row);
            });
            container.appendChild(listGroup);
        }

        function renderShop() {
            const container = document.getElementById('shopListContainer');
            container.innerHTML = '';

            if (productsDB.length === 0) {
                container.innerHTML = `<div class="loader">–ú–∞–≥–∞–∑–∏–Ω –ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`;
                return;
            }

            const listGroup = document.createElement('div');
            listGroup.className = 'list-group';

            productsDB.forEach((product) => {
                const isPurchased = purchasedProductIds.includes(product.id);
                const row = document.createElement('div');
                row.className = `task-row ${isPurchased ? 'completed' : ''}`;
                
                row.innerHTML = `
                    <div class="task-icon">${product.image}</div>
                    <div class="task-content">
                        <div class="task-header-line">
                            <span class="task-title">${product.title}</span>
                            ${!isPurchased ? `<span class="price-tag">${product.price} üíé</span>` : ''}
                        </div>
                        <div class="task-desc">${product.description}</div>
                    </div>
                    <button class="btn-buy" onclick="handleBuy(${product.id}, ${product.price}, '${product.title}')">
                        ${isPurchased ? '–ö–£–ü–õ–ï–ù–û' : '–ö–£–ü–ò–¢–ò'}
                    </button>
                `;
                listGroup.appendChild(row);
            });
            container.appendChild(listGroup);
        }

        // --- ACTIONS ---
        function handleTask(taskId) {
            if (completedTaskIds.includes(taskId)) return;
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            const selectedTask = tasksDB.find(t => t.id === taskId);
            const flowId = "696be91e0f12dc4a9001cfc8"; 
            const params = new URLSearchParams({
                start: flowId,
                task_id: selectedTask.id,
                task_category: selectedTask.category,
                task_level: selectedTask.level,
                task_title: selectedTask.title,
                task_description: selectedTask.description,
                task_reward: selectedTask.reward,
                task_type: selectedTask.submission_type || 'text' 
            });
            tg.openLink(`https://tg.pulse.is/noo_panic_bot?${params.toString()}`); 
            tg.close();
        }

        // --- BUY LOGIC ---
        async function handleBuy(productId, price, title) {
            if (purchasedProductIds.includes(productId)) return;
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');

            if (currentBalance < price) {
                alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º–æ–Ω–µ—Ç! –¢–æ–±—ñ —Ç—Ä–µ–±–∞ —â–µ ${price - currentBalance} üíé`);
                return;
            }

            const isConfirmed = confirm(`–ö—É–ø–∏—Ç–∏ "${title}" –∑–∞ ${price} –º–æ–Ω–µ—Ç?`);
            if (!isConfirmed) return;

            try {
                const { data, error } = await supabaseClient
                    .rpc('buy_product', { p_user_id: userId, p_product_id: productId });

                if (error) throw error;

                if (data === 'success') {
                    alert(`–£—Å–ø—ñ—à–Ω–æ! –¢–∏ –∫—É–ø–∏–≤ "${title}".`);
                    currentBalance -= price;
                    document.getElementById('userCoins').innerText = currentBalance;
                    purchasedProductIds.push(productId);
                    renderShop();
                } else if (data === 'not_enough_money') {
                    alert('–ü–æ–º–∏–ª–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤.');
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + data);
                }
            } catch (err) {
                console.error(err);
                alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø—Ü—ñ.');
            }
        }

        initApp();
    </script>
</body>
</html>